<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Management Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .ai-message .chat-bubble {
            background-color: #ffffff;
            color: #1e293b;
        }
        .user-message .chat-bubble {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* Message pop-in animation */
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .message-pop-in {
            animation: popIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200 flex flex-col h-screen antialiased">

    <!-- Header -->
    <header class="sticky top-0 bg-white/80 backdrop-blur-xl z-10 border-b border-slate-200/80">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center space-x-4">
                <div class="p-2.5 bg-gradient-to-br from-red-500 to-orange-500 rounded-full text-white shadow-lg shadow-red-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">Disaster Management Assistant</h1>
                    <p class="text-sm text-slate-500">Your AI guide for emergency situations</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Chat Container -->
    <div class="flex-1 flex items-center justify-center p-4">
        <main class="flex flex-col h-full max-h-[750px] w-full max-w-4xl bg-white/60 backdrop-blur-lg rounded-2xl shadow-2xl shadow-slate-300/60 overflow-hidden">
            <!-- Chat Window -->
            <div id="chat-window" class="flex-1 space-y-6 overflow-y-auto p-4 md:p-6">
                <div class="flex items-start space-x-3 ai-message message-pop-in">
                    <div class="p-2 bg-slate-200 rounded-full text-slate-600 shadow-inner">
                       <i class="fas fa-robot"></i>
                    </div>
                    <div class="flex flex-col items-start">
                        <div class="chat-bubble">
                            <p class="text-sm leading-relaxed">I am your AI Disaster Management Assistant. I can help if you are in danger during a flood, earthquake, or other disaster.
                            <br><br>
                            <strong>How can I help you? Please describe your current situation.</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden flex items-center space-x-3 p-4 md:p-6">
                <div class="p-2 bg-slate-200 rounded-full text-slate-600 shadow-inner">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-bubble ai-message">
                    <div class="flex items-center justify-center space-x-1.5">
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 bg-white/80 backdrop-blur-xl border-t border-slate-200/80">
                <div class="flex items-center bg-slate-100 border border-slate-300 rounded-xl shadow-sm">
                    <input type="text" id="user-input" placeholder="Type your message here..." class="flex-1 p-3 bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-500">
                    <button id="send-btn" class="px-5 py-3 text-white bg-blue-600 rounded-r-xl hover:bg-blue-700 focus:outline-none transition-colors duration-300">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        const systemPrompt = `You are the "Disaster Management Assistant," an AI expert in survival and safety. Your primary mission is to provide immediate, life-saving guidance to users facing natural disasters like floods, earthquakes, cyclones, or wildfires. Assume users are under extreme stress with limited access to power, internet, and resources. Your communication style must be calm, empathetic, and reassuring.

        Your responses MUST follow this strict protocol:

        1. Triage and Assess (The First Response): Immediately try to understand the type of disaster and the user's immediate situation. If the user is vague, ask a critical clarifying question. For example: "I am here to help. Please tell me your immediate situation. Are you or anyone with you injured? Where are you located right now?"

        2. Prioritize Actions (The Core Guidance): Structure your guidance in a strict, life-saving order. Use simple language, bullet points, and numbered steps.
        - Priority #1: Immediate Safety & First Aid. Focus on escaping immediate danger (e.g., moving to higher ground during a flood, "Drop, Cover, and Hold On" during an earthquake) and addressing life-threatening injuries.
        - Priority #2: Essential Resources. Once immediate safety is addressed, guide them on securing essentials like clean water and safe food.
        - Priority #3: Shelter & Communication. Finally, provide instructions on creating temporary shelter, signaling for help, or finding official support channels.

        3. Provide Practical, Actionable Steps: Offer simple, do-it-yourself (DIY) solutions for common problems. Use clear, step-by-step formats.

        Behavioral Rules:
        - Tone: Always calm, patient, and supportive. Start responses with reassuring phrases like, "Okay, let's work through this step-by-step," or "I understand this is a frightening situation. I am here to help."
        - Simplicity: Use short sentences and basic vocabulary. Avoid technical jargon.
        - Format: Use emojis, bullet points (*), and numbered lists (1.) to make information easy to scan.
        - Focus: Do not deviate from the user's immediate survival needs. Stick to the mission.`;
        
        let conversationHistory = [{
            role: "system",
            parts: [{ text: systemPrompt }]
        }];

        function addMessage(role, text) {
            const messageWrapper = document.createElement('div');
            const iconWrapper = document.createElement('div');
            const bubbleWrapper = document.createElement('div');
            const chatBubble = document.createElement('div');
            
            messageWrapper.className = `flex items-start space-x-3 ${role === 'user' ? 'user-message justify-end' : 'ai-message'}`;
            messageWrapper.classList.add('message-pop-in');

            iconWrapper.className = 'p-2 rounded-full shadow-inner';
            bubbleWrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;
            chatBubble.className = 'chat-bubble';

            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            chatBubble.innerHTML = `<p class="text-sm leading-relaxed">${formattedText}</p>`;

            if (role === 'user') {
                iconWrapper.innerHTML = '<i class="fas fa-user"></i>';
                iconWrapper.className += ' bg-blue-100 text-blue-600';
                bubbleWrapper.appendChild(chatBubble);
                messageWrapper.appendChild(bubbleWrapper);
                messageWrapper.appendChild(iconWrapper);
            } else {
                iconWrapper.innerHTML = '<i class="fas fa-robot"></i>';
                iconWrapper.className += ' bg-slate-200 text-slate-600';
                bubbleWrapper.appendChild(chatBubble);
                messageWrapper.appendChild(iconWrapper);
                messageWrapper.appendChild(bubbleWrapper);
            }
            
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function handleSendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText) return;

            addMessage('user', messageText);
            conversationHistory.push({ role: 'user', parts: [{ text: messageText }] });
            userInput.value = '';
            
            typingIndicator.classList.remove('hidden');
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                const aiResponse = await getAIResponseWithBackoff();
                conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                addMessage('model', aiResponse);

            } catch (error) {
                console.error("Error fetching AI response:", error);
                addMessage('model', "I'm sorry, but I'm having trouble connecting right now. Please check your internet connection and try again.");
            } finally {
                typingIndicator.classList.add('hidden');
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        async function getAIResponseWithBackoff() {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: conversationHistory,
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        const errorData = await response.json();
                        console.error("API Error:", errorData);
                        return `An error occurred: ${errorData.error.message}`;
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const finishReason = result.candidates?.[0]?.finishReason;
                        if (finishReason === 'SAFETY') {
                            return "I cannot respond to this topic. Let's focus on disaster safety.";
                        }
                        return "I received an unusual response. Could you please rephrase your question?";
                    }
                } catch (error) {
                    console.log(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                    if (i < 4) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        sendBtn.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSendMessage();
            }
        });

    </script>
</body>
</html>
